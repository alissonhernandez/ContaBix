<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Nuevo Asiento - Contabix</title>
    <link rel="stylesheet" th:href="@{/css/libro-diario-form.css}">
    <link rel="stylesheet" th:href="@{/css/inicio.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- Choices.js para selects con bÃºsqueda -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</head>

<body>
<nav class="navbar">
    <div class="logo">Contabix</div>
    <ul class="nav-links">
        <li><a th:href="@{/inicio}">Inicio</a></li>
        <li><a th:href="@{/admin/usuarios}">Usuarios</a></li>
        <li><a th:href="@{/libro-diario}">Libro Diario</a></li>
        <li><a th:href="@{/libro-mayor}">Libro Mayor</a></li>
        <li><a th:href="@{/logout}">Cerrar sesiÃ³n</a></li>
    </ul>
</nav>

<div class="asiento-form">
    <h2>Registro de Asiento Contable</h2>

    <div th:if="${error}" style="color:red; text-align:center;" th:text="${error}"></div>

    <form method="post" th:action="@{/libro-diario/guardar}" th:object="${asiento}">


        <div class="form-group">
            <label>Fecha:</label>
            <input type="date" th:field="*{fecha}" required>
        </div>
        <div class="form-group">
            <label>DescripciÃ³n:</label>
            <input type="text" th:field="*{descripcion}" placeholder="Ejemplo: Pago de servicios" required>
        </div>

        <div class="table-section">
            <h3>Detalles del Asiento</h3>

            <table class="tabla-asiento" id="tablaDetalles">
                <thead>
                <tr>
                    <th>Cuenta</th>
                    <th>Debe</th>
                    <th>Haber</th>
                </tr>
                </thead>
                <tbody id="tbodyDetalles">
                <tr th:each="detalle, iterStat : ${asiento.detalles}">
                    <td>
                        <select class="sel-cuenta" th:field="*{detalles[__${iterStat.index}__].cuenta.id}">
                            <option value="">--Seleccione--</option>
                            <option th:each="cuenta : ${cuentas}" th:value="${cuenta.id}"
                                    th:text="${cuenta.codigo + ' - ' + cuenta.nombre}"></option>
                        </select>
                    </td>
                    <td>
                        <div class="input-money">
                            <span>$</span>
                            <input type="text" class="inp-debe" th:field="*{detalles[__${iterStat.index}__].debe}">
                        </div>
                    </td>
                    <td>
                        <div class="input-money">
                            <span>$</span>
                            <input type="text" class="inp-haber" th:field="*{detalles[__${iterStat.index}__].haber}">
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>

            <button type="button" class="btn-add" id="btnAgregarFila">+ Agregar fila</button>

            <!-- Plantilla de fila -->
            <template id="filaTemplate">
                <tr>
                    <td>
                        <select class="sel-cuenta">
                            <option value="">--Seleccione--</option>
                        </select>
                    </td>
                    <td>
                        <div class="input-money">
                            <span>$</span>
                            <input type="text" class="inp-debe">
                        </div>
                    </td>
                    <td>
                        <div class="input-money">
                            <span>$</span>
                            <input type="text" class="inp-haber">
                        </div>
                    </td>
                </tr>
            </template>

            <!-- Opciones base para copiar -->
            <select id="templateOptions" style="display:none;">
                <option value="">--Seleccione--</option>
                <option th:each="cuenta : ${cuentas}" th:value="${cuenta.id}"
                        th:text="${cuenta.codigo + ' - ' + cuenta.nombre}"></option>
            </select>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-guardar">ðŸ’¾ Guardar Asiento</button>
        </div>
    </form>
</div>

<footer>
    <p>&copy; 2025 Contabix. Todos los derechos reservados.</p>
</footer>

<script th:inline="javascript">
    /*<![CDATA[*/
    (function () {
        let contador = /*[[${asiento.detalles.size()}]]*/ 0;
        const btnAgregar = document.getElementById('btnAgregarFila');
        const tbody = document.getElementById('tbodyDetalles');
        const template = document.getElementById('filaTemplate');
        const templateOptions = document.getElementById('templateOptions').innerHTML;

        // Inicializar Choices.js en selects existentes
        document.querySelectorAll('.sel-cuenta').forEach(sel => {
            new Choices(sel, { searchEnabled: true, itemSelectText: '', shouldSort: false });
        });

        // Agregar nueva fila
        btnAgregar.addEventListener('click', () => {
            const frag = template.content.cloneNode(true);
            const sel = frag.querySelector('.sel-cuenta');
            const inpDebe = frag.querySelector('.inp-debe');
            const inpHaber = frag.querySelector('.inp-haber');

            // Agregar las opciones al nuevo select
            sel.innerHTML = templateOptions;

            // Asignar nombres con el Ã­ndice actual
            sel.setAttribute('name', `detalles[${contador}].cuenta.id`);
            inpDebe.setAttribute('name', `detalles[${contador}].debe`);
            inpHaber.setAttribute('name', `detalles[${contador}].haber`);

            tbody.appendChild(frag);

            // Inicializar Choices.js en el nuevo select
            setTimeout(() => {
                new Choices(sel, { searchEnabled: true, itemSelectText: '', shouldSort: false });
                sel.focus();
            }, 50);

            contador++;
        });

        // Reemplazar comas por puntos antes de enviar
        document.querySelector('form').addEventListener('submit', function (e) {
            document.querySelectorAll('.inp-debe, .inp-haber').forEach(input => {
                input.value = input.value.replace(',', '.');
            });
        });
    })();
    /*]]>*/
</script>

</body>
</html>
